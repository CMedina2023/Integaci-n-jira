name: Actualizar y Finalizar Jira

on:
  repository_dispatch:
    types: [jenkins-test-finished]

jobs:
  update-jira:
    runs-on: ubuntu-latest
    steps:
      - name: Debug Info
        run: echo "Procesando ticket ${{ github.event.client_payload.jira_issue }}"

      - name: Login en Jira
        uses: atlassian/gajira-login@master
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # 1. COMENTAR (Siempre que Jenkins termine)
      - name: Comentar Resultados
        uses: atlassian/gajira-comment@master
        with:
          issue: ${{ github.event.client_payload.jira_issue }}
          comment: |
            h3. ðŸš€ Jenkins Report
            * **Estado:** âœ… ${{ github.event.client_payload.jenkins_status }}
            * **Build:** [#${{ github.event.client_payload.jenkins_build }}|${{ github.event.client_payload.jenkins_url }}]
            _ValidaciÃ³n automÃ¡tica completada._

# 2. Marcar como DONE solo si Jenkins dice que fue EXITOSO
      - name: Marcar como Done
        # CondiciÃ³n: Leemos el estado que nos enviÃ³ Jenkins en el JSON
        if: github.event.client_payload.jenkins_status == 'success' 
        uses: atlassian/gajira-transition@v3
        with:
          # ID del Ticket: Lo tomamos del paquete que enviÃ³ Jenkins
          issue: ${{ github.event.client_payload.jira_issue }}
          # Nombre de la transiciÃ³n (Â¡OJO! Debe ser exacto como en tu Jira: 'Done', 'Finalizado', etc.)
          transition: 'finalizado'
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
